name: Figma Variables Sync

on:
  # Manual execution possible
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-figma-tokens:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          # Install node-fetch for Figma API requests
          npm install node-fetch@3

      - name: Configure Git
        run: |
          git config --global user.name "enovaui-bot"
          git config --global user.email "enovaui@lge.com"

      - name: Check Figma Variables
        id: figma-check
        env:
          FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
          FIGMA_FILE_URL: ${{ secrets.FIGMA_FILE_URL }}
        run: |
          echo "ðŸŽ¨ Checking Figma Variables..."
          node scripts/figma-sync.js
          
          # Check if there are changes
          if [ -f "figma-changes.json" ]; then
            CHANGES=$(node -e "
              const changes = require('./figma-changes.json').changes;
              const total = Object.keys(changes.added).length + Object.keys(changes.modified).length + Object.keys(changes.removed).length;
              console.log(total);
            ")
            echo "Changes: $CHANGES"
            echo "has_changes=$CHANGES" >> $GITHUB_OUTPUT
            
            if [ "$CHANGES" -gt "0" ] || [ "${{ inputs.force_sync }}" = "true" ]; then
              echo "proceed=true" >> $GITHUB_OUTPUT
            else
              echo "proceed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_changes=0" >> $GITHUB_OUTPUT
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

      - name: Transform Tokens
        if: steps.figma-check.outputs.proceed == 'true'
        run: |
          echo "ðŸ”„ Transforming tokens..."
          node scripts/token-transformer.js

      - name: Validate Tokens
        if: steps.figma-check.outputs.proceed == 'true'
        run: |
          echo "âœ… Validating tokens..."
          
          # Validate JSON file syntax
          find packages -name "*.json" -type f | while read file; do
            if ! node -e "JSON.parse(require('fs').readFileSync('$file', 'utf8'))"; then
              echo "âŒ JSON syntax error: $file"
              exit 1
            fi
          done
          
          # Validate CSS files (basic syntax check)
          find packages -name "*.css" -type f | while read file; do
            if ! grep -q ":root" "$file"; then
              echo "âš ï¸ CSS file missing :root selector: $file"
            fi
          done
          
          echo "âœ… All token files are valid."

      - name: Run Tests
        if: steps.figma-check.outputs.proceed == 'true'
        run: |
          echo "ðŸ§ª Running token tests..."
          
          # Check token reference integrity
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            function checkReferences(dir) {
              const files = fs.readdirSync(dir, { withFileTypes: true });
              
              for (const file of files) {
                const fullPath = path.join(dir, file.name);
                
                if (file.isDirectory()) {
                  checkReferences(fullPath);
                } else if (file.name.endsWith('.json')) {
                  try {
                    const content = JSON.parse(fs.readFileSync(fullPath, 'utf8'));
                    // TODO: Implement reference check logic
                    console.log('âœ… Reference check completed:', fullPath);
                  } catch (error) {
                    console.error('âŒ Reference check failed:', fullPath, error.message);
                    process.exit(1);
                  }
                }
              }
            }
            
            checkReferences('./packages');
          "

      - name: Create Pull Request
        if: steps.figma-check.outputs.proceed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIGMA_FILE_URL: ${{ secrets.FIGMA_FILE_URL }}
          PR_REVIEWERS: ${{ secrets.PR_REVIEWERS }}
        run: |
          echo "ðŸš€ Creating Pull Request..."
          node scripts/pr-generator.js

      - name: Notify Results
        if: always()
        env:
          TEAMS_WORKFLOW_WEBHOOK_URL: ${{ secrets.TEAMS_WORKFLOW_WEBHOOK_URL }}
        run: |
          if [ "${{ steps.figma-check.outputs.has_changes }}" -gt "0" ]; then
            STATUS="âœ… Figma token sync completed"
            MESSAGE="${{ steps.figma-check.outputs.has_changes }} tokens were updated."
            STATUS_ICON="âœ…"
          else
            STATUS="â„¹ï¸ No changes detected"
            MESSAGE="No changed tokens found in Figma."
            STATUS_ICON="â„¹ï¸"
          fi
          
          echo "$STATUS: $MESSAGE"
          
          # Microsoft Teams notification via Teams Workflows (optional)
          if [ -n "$TEAMS_WORKFLOW_WEBHOOK_URL" ]; then
            REPO_URL="https://github.com/${{ github.repository }}"
            RUN_URL="$REPO_URL/actions/runs/${{ github.run_id }}"
            COMMIT_URL="$REPO_URL/commit/${{ github.sha }}"

            curl -X POST -H 'Content-Type: application/json' \
              --data "{
                \"status_icon\": \"$STATUS_ICON\",
                \"status\": \"$STATUS\",
                \"message\": \"$MESSAGE\",
                \"repository\": \"${{ github.repository }}\",
                \"branch\": \"${{ github.ref_name }}\",
                \"actor\": \"${{ github.actor }}\",
                \"run_url\": \"$RUN_URL\",
                \"commit_url\": \"$COMMIT_URL\",
                \"commit_sha\": \"${{ github.sha }}\",
                \"workflow\": \"${{ github.workflow }}\",
                \"event\": \"${{ github.event_name }}\",
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }" \
              "$TEAMS_WORKFLOW_WEBHOOK_URL"
          fi

      - name: Cleanup
        if: always()
        run: |
          # Clean up temporary files
          rm -f figma-changes.json token-update-manifest.json pr-result.json
          
          # Return to main branch if a branch was created
          git checkout main 2>/dev/null || true
